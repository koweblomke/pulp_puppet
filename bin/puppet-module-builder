#!/usr/bin/env python
#
# Copyright (c) 2013 Red Hat, Inc.
#
# This software is licensed to you under the GNU General Public
# License as published by the Free Software Foundation; either version
# 2 of the License (GPLv2) or (at your option) any later version.
# There is NO WARRANTY for this software, express or implied,
# including the implied warranties of MERCHANTABILITY,
# NON-INFRINGEMENT, or FITNESS FOR A PARTICULAR PURPOSE. You should
# have received a copy of GPLv2 along with this software; if not, see
# http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.

import os
import sys
import shutil

from gettext import gettext as _
from optparse import OptionParser, OptionGroup
from subprocess import Popen, PIPE
from hashlib import sha256


PKG_DIR = 'pkg'
ARCHIVE_SUFFIX = '.tar.gz'


PATH = _('the path to be searched for puppet modules. the path may be either'
         ' an absolute path or a path that is relative to the working directory.'
         ' when not specified, the working directory is searched.')

URL = _('the URL to a git repository to be cloned. repositories'
        ' will be cloned into the working directory. cloning will'
        ' set the (-p|--path) to the repository root when (-p|--path) is'
        ' not specified.')

BRANCH = _('the name of a git branch to be checked out.')

TAG = _('the name of a git tag to be checked out.')

WORKING_DIR = _('set the working directory. default: current directory.')

OUTPUT_DIR = _('set the output directory. this can be either an absolute path'
               ' or a path that is relative to the working directory.'
               ' default: working directory.')

CLEAN = _('delete cloned repositories before and after building.')

USAGE = _('%prog <options> [working-dir]'
          '\n\nBuild puppet modules.'
          '\n\nSearch the working directory and build all puppet modules found. The working'
          '\ndirectory is the current directory unless the (-w|--working-dir) option is specified.'
          '\nThe (-p|--path) option may be used to specify a directory to search/build and'
          '\ncan be either an absolute path or a path relative to the working directory.'
          '\nThe archive built using \'puppet module build\' is copied to the output directory'
          '\nThe output directory is the current directory unless (-o|--output-dir) is'
          '\nspecified.  The output directory may be either an absolute path or a path that is'
          '\nrelative to the working directory.'
          '\n\nSeveral options are provided for working with git.  Repositories may be cloned'
          '\nby specifying the (-u|--url) option. After cloning git repositories, the (-p|--path)'
          '\nis set to the root of the cloned repository unless specified explicitly.'
          '\nThe repository branch may be selected by using the (-b|--branch) option.'
          '\nIn all cases, when the working directory is a git repository, a \'git pull\' is'
          '\nperformed to ensure that the repository is up to date.'
          '\n')


def chdir(path):
    if path:
        print 'cd %s' % path
        os.chdir(path)


def shell(command, exit_on_err=True):
    print command
    call = command.split()
    p = Popen(call, stdout=PIPE, stderr=PIPE)
    status, output = p.wait(), p.stdout.read()
    if exit_on_err and status != 0:
        print p.stderr.read()
        sys.exit(status)
    return status, output


def get_options():
    parser = OptionParser(usage=USAGE)
    parser.add_option('-w', '--working-dir', dest='working_dir', help=WORKING_DIR)
    parser.add_option('-o', '--output-dir', dest='output_dir', help=OUTPUT_DIR)
    parser.add_option('-c', '--clean', default=False, action='store_true', help=CLEAN)
    git = OptionGroup(parser, 'git')
    git.add_option('-u', '--url', help=URL)
    git.add_option('-b', '--branch', help=BRANCH)
    git.add_option('-t', '--tag', help=TAG)
    parser.add_option('-p', '--path', help=PATH)
    parser.add_option_group(git)
    (opts, args) = parser.parse_args()
    if not opts.working_dir:
        if args:
            opts.working_dir = args[0]
        else:
            opts.working_dir = os.getcwd()
    if not opts.output_dir:
        opts.output_dir = opts.working_dir
    if not opts.path and opts.url:
        opts.path = os.path.basename(opts.url)
    return opts


def set_origin(options):
    status, output = shell('git status', False)
    if status != 0:
        options.origin = None
        return
    status, output = shell('git remote show -n origin')
    for line in output.split('\n'):
        line = line.strip()
        if line.startswith('Fetch URL:'):
            url = line.split(':', 1)[1]
            options.origin = url.strip()


def git_clone(options):
    if not options.url:
        # cloning not requested
        return
    shell('git clone %s' % options.url)


def git_checkout(options):
    if not options.origin:
        # not in a git repository
        return
    shell('git fetch')
    shell('git fetch --tags')
    if options.branch:
        shell('git checkout %s' % options.branch)
    if options.tag:
        shell('git checkout %s' % options.tag)
    shell('git pull')


def find_modules():
    status, output = shell('find . -name init.pp')
    for path in output.split('\n'):
        _path = path.split('/')
        if len(_path) < 3:
            continue
        if _path[-2] != 'manifests':
            continue
        if len(_path) > 3 and _path[-4] == PKG_DIR:
            continue
        module_dir = '/'.join(_path[:-2])
        yield module_dir


def publish_module(module_dir, publish_dir):
    shell('mkdir -p %s' % publish_dir)
    for name in os.listdir(module_dir):
        if not name.endswith(ARCHIVE_SUFFIX):
            continue
        path = os.path.join(module_dir, name)
        shutil.copy(path, publish_dir)
        print 'cp %s %s' % (path, publish_dir)


def build_puppet_modules(options):
    for path in find_modules():
        shell('puppet module build %s' % path)
        pkg_dir = os.path.join(path, PKG_DIR)
        publish_module(pkg_dir, options.output_dir)


def digest(path):
    h = sha256()
    with open(path) as fp:
        h.update(fp.read())
    return h.hexdigest()


def build_manifest(options):
    _dir = os.getcwd()
    chdir(options.output_dir)
    with open('PULP_MANIFEST', 'w+') as fp:
        for path in os.listdir('.'):
            if not path.endswith(ARCHIVE_SUFFIX):
                continue
            fp.write(path)
            fp.write(',%s' % digest(path))
            fp.write(',%s\n' % os.path.getsize(path))
    chdir(_dir)


def clean(options):
    if options.url and options.clean:
        path = os.path.join(options.working_dir, os.path.basename(options.url))
        shell('rm -rf %s' % path)


def main():
    _dir = os.getcwd()
    options = get_options()
    clean(options)
    chdir(options.working_dir)
    git_clone(options)
    chdir(options.path)
    set_origin(options)
    git_checkout(options)
    build_puppet_modules(options)
    build_manifest(options)
    chdir(_dir)
    clean(options)


if __name__ == '__main__':
    main()